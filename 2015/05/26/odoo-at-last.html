<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title><manuel> &mdash; Odoo at last!
</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="stylesheet" href="/theme/style-202507261729.css">
  </head>
  <body>
    <header class="logo tw:flex tw:flex-row tw:items-center tw:mx-[auto] tw:max-w-[1100px] tw:py-2 tw:px-4 tw:md:px-8 tw:m-0 tw:md:mb-2">
        <h1 class="tw:m-0">
          <a href="/">&lang;m∀&rang;</a>
        </h1>
      <div class="tw:grow"></div>
        <nav>
          <ul class="tw:flex tw:flex-row tw:gap-4 tw:max-w-[90%] tw:list-none">
                <li><a href="/pages/about.html" >About</a></li>
          </ul>
        </nav>
    </header>
    <main class="tw:p-4 tw:md:p-8">
<article>
    <header>
        <h2>Odoo at&nbsp;last!</h2>
        <p class="meta">2015-05-26 &bull; Manuel Vázquez Acosta</p>
    </header>
    <p>After several months, we have finally moved from OpenERP to Odoo.  It took
several rounds of testing, finding bugs and incompatibilities in our own
modules and fixing&nbsp;them.</p>
<div class="section" id="a-summary-of-the-process">
<h2>A summary of the&nbsp;process</h2>
<p>The <a class="reference external" href="https://github.com/OpenUpgrade/OpenUpgrade">OpenUpgrade</a> project proved to be very complete for us &#8212;it had almost
everything we&nbsp;needed:</p>
<ul class="simple">
<li>The Accounting and Project modules were&nbsp;done.</li>
<li>The <span class="caps">CRM</span> module was not yet integrated into the mainstream repository but a
<a class="reference external" href="https://github.com/StefanRijnhart/OpenUpgrade">fork by Stefan Rijnhart</a> had a branch that proved very
complete for our&nbsp;needs.</li>
</ul>
<p>We began by merging Stefan&#8217;s branch into our own clone of the repository.  We
came into a small issue and <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/commit/57cd439">fixed it</a>.  Afterwards, some of our
recurrent events were missing the timezone and the migration failed.  For that
we created the branch <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/8.0-valid-rrules">8.0-valid-rrules</a> and it did the job after a couple of&nbsp;tweeks.</p>
<p>The branch we actually used for the migration is <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/merchise-8.0">merchise-8.0</a>.  It includes
several commits we had to make for our customs addons to work.  Those commits
are probably too local to be merged back into the upstream.  However, we have
published them should anyone finds them&nbsp;useful.</p>
</div>
<div class="section" id="the-menu-decomposition">
<h2>The menu&nbsp;decomposition</h2>
<p>The biggest issue we&#8217;ve encountered so far is that after several hours of
operation all the menus stopped working: You clicked the &#8220;Leads&#8221; menu item and
you got, say, the list of Many2Many fields.&nbsp;(???!!!)</p>
<p>A first inspection showed that all menu items in the <span class="caps">HTML</span> were <em>somehow</em>
related to the same action id.  Quickly, we truncated the <tt class="docutils literal">ir_ui_menu</tt> table
and its associated <tt class="docutils literal">ir_model_data</tt> rows, upgraded the <span class="caps">DB</span> and all menus came
to life once&nbsp;more.</p>
<p>The day after, the same problem happened.  Deeper inspection of both the code
and the <span class="caps">DB</span> showed the problem lied in the <tt class="docutils literal">ir_values</tt> table.  That table
relates menu items with actions.  The rows containing this relation showed
nonsense: almost all the menu items were related to &#8220;<tt class="docutils literal">res_partner,20</tt>&#8220;.  And
in the <span class="caps">UI</span> this was interpreted to be pointing to the action with id&nbsp;20.</p>
<p>Comparing the table before and after the upgrade showed no problem there.  So
this issue had appeared after the migration&nbsp;itself.</p>
<p>Our previous method of truncating <tt class="docutils literal">ir_ui_menu</tt> didn&#8217;t fix this issue cause
the <tt class="docutils literal">ir_values</tt> rows remained there crippling over and over again.  Besides,
truncating <tt class="docutils literal">ir_ui_menu</tt> had the unintentional, bad side-effect of removing
every Mail list in our <span class="caps">DB</span>.</p>
<p>We&#8217;re still on the track about how the <tt class="docutils literal">ir.values</tt> were messed up in the
first&nbsp;place.</p>
</div>
<div class="section" id="the-magical-6-tabs">
<h2>The magical 6&nbsp;tabs</h2>
<p>Our users started to report slowness after a couple of hours of working.
First, we noticed that the call to <tt class="docutils literal">load_needaction</tt> was taking too long and
find out this call asked for too much it did not need, we <a class="reference external" href="https://github.com/odoo/odoo/pull/6772">provided a fix</a> and some loose benchmarks.  Though this patch needs
to be completed, the slowness was solved&#8230; for a&nbsp;moment.</p>
<p>Some users kept reporting the Odoo interface was freezing all the time, even
inviting them to go out and drink a cup of coffee&#8230;  But other users were
happy about it after the patch.  Closer inspection showed many of the <span class="caps">AJAX</span>
calls were blocking waiting for a socket to be&nbsp;available.</p>
<p>It turned out these users had created a habit of opening several tabs when
they worked with OpenERP.  They kept this kind of behavior, but a couple of
facts worked against&nbsp;them:</p>
<ul>
<li><p class="first">We have installed the Odoo chat.  Many of our users are geographically
spread, the chat provided an instant and cheaper communication&nbsp;path.</p>
<p>This feature was, by far, one the reason we moved to Odoo in the first&nbsp;place.</p>
<p>On technical side, the chat works by long polling the server.  In our server
this connection stays open for about 50s before being dropped (only to be
reestablished a moment&nbsp;later).</p>
<p>This means: a tab has always at least a connection open to the&nbsp;server.</p>
</li>
<li><p class="first">As explained by Ilya Grigorik in <a class="reference external" href="http://www.aosabook.org/en/posa/high-performance-networking-in-chrome.html">High Performance Networking in Chrome</a>,
browsers make only so many connections to the same combination of scheme,
host and&nbsp;port.</p>
<p>In Chrome this number is 6.  In Firefox this can be tuned up or down by
tweaking the <tt class="docutils literal"><span class="pre">network.http.max-persistent-connections-per-server</span></tt>
parameter, but the default is&nbsp;6.</p>
</li>
</ul>
<p>Combining these, it means that after opening about 6 tabs every <span class="caps">AJAX</span> call has
to wait up to 50s to be able to even reach the&nbsp;server.</p>
<p>We opted for raising this number in Firefox and to warn users about this.  Our
user base is small enough and the server has yet to achieve any noticeable&nbsp;load.</p>
</div>
<div class="section" id="epilogue">
<h2>Epilogue</h2>
<p>That&#8217;s what our migration to Odoo story has gone so far.  A little bit
stressful at times, specially when the menus went south for the second time,
but I think we have crossed the yellow line now.  Should anything comes I&#8217;ll
report&nbsp;it.</p>
<p>I&#8217;d love to hear (or read) about others, so I can learn from their&nbsp;experience.</p>
</div>
<div class="section" id="updated-2015-06-03">
<h2>Updated&nbsp;2015-06-03</h2>
<p><a class="reference internal" href="#the-menu-decomposition">The menu decomposition</a> described above was actually an error in a custom
addon and not related with migration&nbsp;process.</p>
<p>While still using OpenERP, we backported the partner merge feature from Odoo
and made it work in OpenERP.  We even added a fuzzy match feature so that
minor typos were not missed.  Now in Odoo it seems our modifications messed
things&nbsp;up.</p>
</div>

</article>
    </main>
    <footer>
      <p>&copy; 2016-2025 Manuel Vázquez Acosta</p>
      <p>Content licensed under the Creative Commons
        attribution-noncommercial-sharealike License.</p>
    </footer>
    <script src="/theme/js/section_anchor.js"></script>
  </body>
</html>

